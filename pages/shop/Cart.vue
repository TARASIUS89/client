<template>
    <div class="container mx-auto px-4 py-8">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold dark:text-white">–ö–æ—Ä–∑–∏–Ω–∞</h1>
            <NuxtLink to="/shop" class="inline-flex items-center text-blue-500 hover:text-blue-600 dark:text-blue-400 transition-colors">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
            </NuxtLink>
        </div>

        <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
        <div v-if="!cart.length" class="text-center py-16">
            <div class="mb-6">
                <svg class="w-24 h-24 mx-auto text-gray-400 dark:text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            </div>
            <h2 class="text-2xl font-semibold text-gray-600 dark:text-gray-400 mb-4">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
            <p class="text-gray-500 dark:text-gray-500 mb-8">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
            <NuxtLink to="/shop" class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                <svg class="w-5 h-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </NuxtLink>
        </div>

        <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div class="lg:col-span-2 space-y-4">
                <div v-for="item in cart" :key="item.id" 
                    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 transition-all duration-300 hover:shadow-md">
                    <div class="flex items-center">
                        <img :src="`https://lebo-sochi.ru/admin${item.cover.url}`" 
                            :alt="item.name"
                            class="w-24 h-24 object-contain rounded-lg bg-gray-50 dark:bg-gray-700"
                        />
                        <div class="ml-6 flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">{{ item.name }}</h3>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <span class="text-xl font-bold text-gray-900 dark:text-white">
                                        {{ formatPrice(item.price) }} ‚ÇΩ
                                    </span>
                                    <span class="text-gray-500 dark:text-gray-400">
                                        √ó {{ item.quantity }}
                                    </span>
                                </div>
                                <button
                                    @click="removeFromCart(item.id)"
                                    class="text-red-500 hover:text-red-600 transition-colors p-2"
                                >
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
                    
                    <!-- –ò—Ç–æ–≥–æ -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600 dark:text-gray-400">–¢–æ–≤–∞—Ä—ã ({{ cart.length }})</span>
                            <span class="text-gray-900 dark:text-white">{{ formatPrice(total) }} ‚ÇΩ</span>
                        </div>
                        <div class="flex justify-between items-center font-semibold">
                            <span class="text-gray-900 dark:text-white">–ò—Ç–æ–≥–æ</span>
                            <span class="text-2xl text-blue-600 dark:text-blue-400">{{ formatPrice(total) }} ‚ÇΩ</span>
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="space-y-4">
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                            </label>
                            <input
                                type="tel"
                                id="phone"
                                v-model="contactData.phone"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors"
                                placeholder="+7 (___) ___-__-__"
                                required
                            />
                        </div>
                        <div>
                            <label for="telegram" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                –ù–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                            </label>
                            <input
                                type="text"
                                id="telegram"
                                v-model="contactData.telegram"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-colors"
                                placeholder="@username"
                                required
                            />
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                    <button
                        @click="checkout"
                        class="w-full mt-6 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="!isFormValid || isLoading"
                    >
                        <span v-if="isLoading" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            –û–±—Ä–∞–±–æ—Ç–∫–∞...
                        </span>
                        <span v-else>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ -->
        <UiSuccessModal v-model="showSuccessModal" />
    </div>
</template>

<script setup>
import { useCartStore } from '~/stores/cart'

const cartStore = useCartStore()
const contactData = ref({
    phone: '',
    telegram: ''
})
const showSuccessModal = ref(false)
const isLoading = ref(false)

// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ store
const cart = computed(() => cartStore.items)

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
const formatPrice = (price) => {
    return new Intl.NumberFormat('ru-RU').format(price)
}

// –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã
const total = computed(() => cartStore.totalPrice)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
const isFormValid = computed(() => {
    return contactData.value.phone && contactData.value.telegram
})

const removeFromCart = (id) => {
    cartStore.removeFromCart(id)
}

const checkout = async () => {
    try {
        if (!isFormValid.value) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è')
            return
        }

        isLoading.value = true

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const message = `
üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑:

${cart.value.map((item) => `
üì¶ ${item.name}
üí∞ –¶–µ–Ω–∞: ${formatPrice(item.price)}‚ÇΩ
üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}
`).join('\n')}

üíµ –ò—Ç–æ–≥–æ: ${formatPrice(total.value)}‚ÇΩ

üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${contactData.value.phone}
üì≤ Telegram: ${contactData.value.telegram}
        `.trim()

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        const token = '7605231803:AAHesk57rNvu8VcHGugwZbWqv_RzttfbQqI';
        const chatId = "160236196";
        
        const response = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'HTML'
            })
        })

        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
        }

        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        cartStore.clearCart()
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        contactData.value = {
            phone: '',
            telegram: ''
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—Ö–∞
        showSuccessModal.value = true

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error)
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.')
    } finally {
        isLoading.value = false
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
onMounted(() => {
    cartStore.initCart()
})

// –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã —á–µ—Ä–µ–∑ store
watch(() => cartStore.items, () => {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è computed —Å–≤–æ–π—Å—Ç–≤—É
}, { deep: true })
</script>